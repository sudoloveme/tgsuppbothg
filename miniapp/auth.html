<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Авторизация - heavengate vpn</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            background: #f5f5f5;
            min-height: 100vh;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #000000;
            min-height: 100vh;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* Экран авторизации */
        .auth-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 400px;
        }

        .auth-card {
            background: #ffffff;
            border-radius: 20px;
            padding: 40px 32px;
            width: 100%;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        .auth-card.fade-out {
            opacity: 0;
            transform: translateX(-20px);
        }

        .auth-card.fade-in {
            opacity: 1;
            transform: translateX(0);
        }

        .auth-card-content {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        .auth-card-content.slide-out {
            opacity: 0;
            transform: translateX(-30px);
        }

        .auth-card-content.slide-in {
            opacity: 1;
            transform: translateX(0);
        }

        .auth-title {
            font-size: 28px;
            font-weight: 700;
            color: #000000;
            text-align: left;
            margin-bottom: 32px;
        }

        .auth-label {
            font-size: 14px;
            color: #000000;
            margin-bottom: 8px;
            display: block;
        }

        .auth-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #e5e5ea;
            border-radius: 12px;
            font-size: 16px;
            color: #000000;
            background: #ffffff;
            box-sizing: border-box;
            margin-bottom: 24px;
            transition: border-color 0.2s;
        }

        .auth-input:focus {
            outline: none;
            border-color: #007AFF;
        }

        .auth-input::placeholder {
            color: #8e8e93;
        }

        .auth-button {
            width: 100%;
            background: #007AFF;
            color: #ffffff;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-bottom: 24px;
        }

        .auth-button:active {
            opacity: 0.8;
        }

        .auth-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .resend-link {
            color: #007AFF;
            font-size: 14px;
            text-decoration: none;
            cursor: pointer;
            display: inline-block;
            margin-bottom: 24px;
            transition: opacity 0.2s;
        }

        .resend-link:active {
            opacity: 0.7;
        }

        .resend-link:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .back-link {
            color: #007AFF;
            font-size: 14px;
            text-decoration: none;
            cursor: pointer;
            display: block;
            text-align: center;
            margin-top: 8px;
            transition: opacity 0.2s;
        }

        .back-link:active {
            opacity: 0.7;
        }

        .auth-agreement {
            font-size: 12px;
            color: #8e8e93;
            text-align: center;
            line-height: 1.5;
        }

        .auth-agreement-link {
            color: #007AFF;
            text-decoration: none;
        }

        @media (max-width: 480px) {
            .auth-card {
                padding: 32px 24px;
            }
            
            .auth-title {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="auth-screen">
        <div class="auth-card fade-in">
            <div class="auth-card-content">
                <div class="auth-title">Авторизация</div>
                <label class="auth-label" for="authEmail">Введите ваш Email</label>
                <input 
                    type="email" 
                    id="authEmail" 
                    class="auth-input" 
                    placeholder="example@gmail.com"
                    autocomplete="email"
                >
                <button class="auth-button" onclick="handleAuth()">
                    Авторизоваться
                </button>
                <div class="auth-agreement">
                    Авторизовываясь, вы соглашаетесь с нашей 
                    <a href="#" class="auth-agreement-link" onclick="event.preventDefault(); tg.showAlert('Политика конфиденциальности будет добавлена позже');">Политикой конфиденциальности</a> 
                    и 
                    <a href="#" class="auth-agreement-link" onclick="event.preventDefault(); tg.showAlert('Пользовательское соглашение будет добавлено позже');">Пользовательским соглашением</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Инициализация Telegram WebApp
        const tg = window.Telegram.WebApp;
        
        // Настройка Mini-App
        tg.ready();
        tg.expand();
        
        // На мобильных устройствах включаем fullscreen
        if (tg.platform === 'ios' || tg.platform === 'android') {
            if (tg.requestFullscreen) {
                tg.requestFullscreen();
            }
        }
        
        // Настройка цветов
        tg.setHeaderColor('#ffffff');
        tg.setBackgroundColor('#f5f5f5');
        
        // Отключаем подтверждение закрытия
        if (tg.disableClosingConfirmation) {
            tg.disableClosingConfirmation();
        }
        
        // Отключаем сворачивание при свайпе вниз
        if (tg.disableVerticalSwipes) {
            tg.disableVerticalSwipes();
        }

        // Получение Telegram ID
        function getTelegramId() {
            try {
                if (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
                    return tg.initDataUnsafe.user.id;
                }
                
                // Fallback: try to parse initData
                if (tg.initData) {
                    const params = new URLSearchParams(tg.initData);
                    const userStr = params.get('user');
                    if (userStr) {
                        const user = JSON.parse(userStr);
                        if (user.id) {
                            return user.id;
                        }
                    }
                }
            } catch (e) {
                console.error('Error getting Telegram ID:', e);
            }
            return null;
        }

        // Обработка отправки OTP
        async function handleAuth() {
            const emailInput = document.getElementById('authEmail');
            const email = emailInput?.value.trim();
            
            if (!email) {
                tg.showAlert('Пожалуйста, введите email');
                return;
            }
            
            // Валидация email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                tg.showAlert('Пожалуйста, введите корректный email адрес');
                return;
            }
            
            // Валидация разрешенных доменов
            const allowedDomains = [
                'gmail.com',
                'yandex.ru',
                'yandex.com',
                'yandex.kz',
                'bk.ru',
                'vk.com',
                'inbox.ru',
                'list.ru',
                'mail.ru',
                'yahoo.com',
                'outlook.com',
                'hotmail.com',
                'icloud.com',
                'protonmail.com',
                'proton.me',
                'heavengate.net',
                'adacigroup.kz'
            ];
            
            const emailDomain = email.split('@')[1]?.toLowerCase() || '';
            if (!allowedDomains.includes(emailDomain)) {
                tg.showAlert('Разрешены только популярные почтовые сервисы (Gmail, Yandex, Mail.ru, Yahoo, Outlook и др.)');
                return;
            }
            
            const telegramId = getTelegramId();
            if (!telegramId) {
                tg.showAlert('Не удалось определить пользователя. Пожалуйста, откройте приложение через Telegram бота.');
                return;
            }
            
            // Отправка OTP
            try {
                const baseUrl = window.location.origin;
                const response = await fetch(`${baseUrl}/api/auth/send-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        telegram_id: telegramId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Показываем форму ввода OTP
                    showOtpForm(email, telegramId);
                } else {
                    tg.showAlert(data.error || 'Ошибка отправки кода. Попробуйте позже.');
                }
            } catch (error) {
                console.error('Error sending OTP:', error);
                tg.showAlert('Ошибка отправки кода. Попробуйте позже.');
            }
        }

        // Показать форму ввода OTP с плавной анимацией
        function showOtpForm(email, telegramId) {
            const card = document.querySelector('.auth-card');
            const currentContent = card.querySelector('.auth-card-content') || card;
            
            // Добавляем класс для анимации исчезновения
            if (currentContent.classList) {
                currentContent.classList.add('slide-out');
            } else {
                card.classList.add('fade-out');
            }
            
            // После завершения анимации исчезновения, меняем контент и показываем новый
            setTimeout(() => {
                // Создаем новый контент
                const newContent = document.createElement('div');
                newContent.className = 'auth-card-content slide-in';
                newContent.innerHTML = `
                    <div class="auth-title">Подтверждение кода</div>
                    <p style="font-size: 14px; color: #000000; margin-bottom: 24px; line-height: 1.5; text-align: left;">
                        Мы отправили 6-ти значный код на<br><strong style="font-weight: 600;">${email}</strong>
                    </p>
                    <label class="auth-label" for="authOtp">Код подтверждения</label>
                    <input 
                        type="text" 
                        id="authOtp" 
                        class="auth-input" 
                        placeholder="Введите код"
                        maxlength="6"
                        autocomplete="one-time-code"
                        inputmode="numeric"
                        pattern="[0-9]*"
                    >
                    <a href="#" class="resend-link" id="resendLink" onclick="event.preventDefault(); handleResendOtp('${email}', ${telegramId}); return false;">
                        Выслать код повторно (<span id="resendTimer">60</span>)
                    </a>
                    <button class="auth-button" onclick="handleVerifyOtp('${email}', ${telegramId})">
                        Подтвердить
                    </button>
                    <a href="#" class="back-link" onclick="event.preventDefault(); location.reload(); return false;">
                        Назад
                    </a>
                `;
                
                // Заменяем содержимое карточки
                card.innerHTML = '';
                card.appendChild(newContent);
                
                // Убираем класс fade-out и добавляем fade-in для плавного появления
                card.classList.remove('fade-out');
                card.classList.add('fade-in');
                
                // Фокус на поле ввода OTP
                setTimeout(() => {
                    const otpInput = document.getElementById('authOtp');
                    if (otpInput) {
                        otpInput.focus();
                    }
                    // Запускаем таймер для кнопки повторной отправки
                    startResendTimer(email, telegramId);
                }, 100);
            }, 300); // Время анимации исчезновения
        }

        // Таймер для ссылки повторной отправки
        let resendTimerInterval = null;
        function startResendTimer(email, telegramId) {
            let secondsLeft = 60;
            const resendLink = document.getElementById('resendLink');
            const timerSpan = document.getElementById('resendTimer');
            
            if (!resendLink || !timerSpan) return;
            
            // Очищаем предыдущий таймер если есть
            if (resendTimerInterval) {
                clearInterval(resendTimerInterval);
            }
            
            // Делаем ссылку неактивной
            resendLink.style.pointerEvents = 'none';
            resendLink.style.opacity = '0.5';
            
            // Обновляем таймер каждую секунду
            resendTimerInterval = setInterval(() => {
                secondsLeft--;
                if (timerSpan) {
                    timerSpan.textContent = secondsLeft;
                }
                
                if (secondsLeft <= 0) {
                    clearInterval(resendTimerInterval);
                    resendTimerInterval = null;
                    if (resendLink) {
                        resendLink.style.pointerEvents = 'auto';
                        resendLink.style.opacity = '1';
                        resendLink.innerHTML = 'Выслать код повторно';
                    }
                }
            }, 1000);
        }

        // Обработка повторной отправки OTP
        async function handleResendOtp(email, telegramId) {
            const resendLink = document.getElementById('resendLink');
            if (resendLink) {
                resendLink.style.pointerEvents = 'none';
                resendLink.style.opacity = '0.5';
                resendLink.textContent = 'Отправка...';
            }
            
            try {
                const baseUrl = window.location.origin;
                const response = await fetch(`${baseUrl}/api/auth/send-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        telegram_id: telegramId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    tg.showAlert('Код отправлен повторно');
                    // Перезапускаем таймер
                    startResendTimer(email, telegramId);
                } else {
                    tg.showAlert(data.error || 'Ошибка отправки кода. Попробуйте позже.');
                    if (resendLink) {
                        resendLink.style.pointerEvents = 'auto';
                        resendLink.style.opacity = '1';
                        resendLink.innerHTML = 'Выслать код повторно';
                    }
                }
            } catch (error) {
                console.error('Error resending OTP:', error);
                tg.showAlert('Ошибка отправки кода. Попробуйте позже.');
                if (resendLink) {
                    resendLink.style.pointerEvents = 'auto';
                    resendLink.style.opacity = '1';
                    resendLink.innerHTML = 'Выслать код повторно';
                }
            }
        }

        // Обработка проверки OTP
        async function handleVerifyOtp(email, telegramId) {
            const otpInput = document.getElementById('authOtp');
            const otpCode = otpInput?.value.trim();
            
            if (!otpCode || otpCode.length !== 6) {
                tg.showAlert('Пожалуйста, введите 6-значный код');
                return;
            }
            
            try {
                const baseUrl = window.location.origin;
                const response = await fetch(`${baseUrl}/api/auth/verify-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        telegram_id: telegramId,
                        otp_code: otpCode
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    tg.showAlert('Авторизация успешна!');
                    // Перенаправляем на главную страницу
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    tg.showAlert(data.error || 'Неверный код. Попробуйте еще раз.');
                }
            } catch (error) {
                console.error('Error verifying OTP:', error);
                tg.showAlert('Ошибка проверки кода. Попробуйте позже.');
            }
        }
    </script>
</body>
</html>

