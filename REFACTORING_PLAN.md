# План рефакторинга bot.py

## Предлагаемая структура

### 1. `database.py` (~280 строк)
**Функции работы с БД:**
- `_db_connect()` - подключение и создание таблиц
- `db_get_thread_id()` - получение thread_id по user_id
- `db_get_user_id()` - получение user_id по thread_id
- `db_set_thread_id()` - сохранение связи user_id ↔ thread_id
- `db_upsert_thread_state()` - обновление состояния темы
- `db_touch_activity()` - обновление активности темы
- `db_get_thread_state()` - получение состояния темы
- `db_save_rating()` - сохранение оценки
- `db_get_ratings_stats()` - статистика оценок
- `db_get_user_ratings()` - оценки пользователя
- `db_save_user_backend_data()` - сохранение данных бэкенда
- `db_get_user_backend_data()` - получение данных бэкенда

**Зависимости:**
- `sqlite3`, `Path`, `logging`
- Глобальные: `SUPPORT_CHAT_ID`, `DB_PATH` (передавать как параметры или через конфиг)

### 2. `commands.py` (~420 строк)
**Команды бота:**
- `cmd_start()` - команда /start
- `cmd_id()` - команда /id
- `cmd_panel()` - команда /panel
- `cmd_linkmail()` - команда /linkmail
- `cmd_info()` - команда /info
- `cmd_stats()` - команда /stats
- `cmd_diag()` - команда /diag

**Зависимости:**
- `database.py` - функции БД
- `api_client.py` - API функции
- `helpers.py` - проверки прав
- `utils.py` - утилиты форматирования

### 3. `handlers.py` (~250 строк)
**Обработчики сообщений:**
- `handle_callback_buttons()` - обработка кнопок
- `handle_incoming_from_user()` - входящие сообщения от пользователей
- `handle_owner_reply()` - ответы оператора
- `archive_inactive_topics_job()` - автоматическая архивация

**Зависимости:**
- `database.py`
- `utils.py`
- `api_client.py` (для уведомлений)

### 4. `utils.py` (~115 строк)
**Утилиты и UI:**
- `build_thread_keyboard()` - клавиатура темы
- `build_rating_keyboard()` - клавиатура оценки
- `send_rating_message()` - отправка сообщения с оценкой
- `notify_admin_about_rating()` - уведомление админам
- `_format_user_header()` - форматирование заголовка пользователя
- `_display_name()` - получение имени пользователя
- `_ensure_forum_topic_for_user()` - создание/получение темы форума

**Зависимости:**
- `database.py`
- Глобальные: `SUPPORT_CHAT_ID`, `RATINGS_NOTIFICATIONS_THREAD_ID`

### 5. `config.py` (новый, ~50 строк)
**Конфигурация:**
- Загрузка переменных окружения
- Валидация конфигурации
- Глобальные переменные

### 6. `bot.py` (~150 строк, упрощенный)
**Основной файл:**
- Импорты
- Инициализация конфигурации
- Регистрация обработчиков
- Функция `main()`

## Преимущества

1. **Читаемость**: Каждый файл отвечает за свою область
2. **Поддержка**: Легче найти и изменить нужный код
3. **Тестирование**: Можно тестировать модули отдельно
4. **Командная работа**: Меньше конфликтов при работе в команде
5. **Масштабируемость**: Легче добавлять новые функции

## Риски и решения

**Риск**: Циклические зависимости
**Решение**: Правильная структура импортов, использование конфига

**Риск**: Нарушение работы существующего кода
**Решение**: Постепенный рефакторинг, тестирование после каждого шага

## Рекомендация

**ДА, стоит разбить**, потому что:
- Файл уже большой (1195 строк)
- Есть четкие логические группы
- Улучшит поддерживаемость
- Не сильно усложнит структуру (всего 5-6 файлов)

