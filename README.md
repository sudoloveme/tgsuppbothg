## Telegram Support Bot

Минимальный бот поддержки: все сообщения от пользователей пересылаются владельцу (вашему аккаунту). Отвечайте владельцу реплаем — ответ уйдёт пользователю.

### 1) Установка

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\\Scripts\\activate
pip install -r requirements.txt
```

### 2) Настройка окружения

Создайте файл `.env` в корне проекта со значениями:

```
TELEGRAM_BOT_TOKEN=123456:ABC-Your-Bot-Token
# Ваш личный Telegram user ID (chat id). Узнать: отправьте /id в ЛС боту
OWNER_ID=123456789
## (опционально) Режим форума: ID супергруппы с включёнными темами
# Пример: -1001234567890
SUPPORT_CHAT_ID=-1001234567890
## (опционально) Путь к SQLite БД (по умолчанию data.db в корне)
DB_PATH=/opt/tg-support-bot/data.db
## (опционально) ID темы для уведомлений об оценках (по умолчанию 1 = General тема)
RATINGS_NOTIFICATIONS_THREAD_ID=1
## (опционально) URL бэкенд API для интеграции с системой пользователей
BACKEND_API_URL=https://api.example.com
## (опционально) API ключ для аутентификации в бэкенд API
BACKEND_API_KEY=your_api_key_here
```

Как получить OWNER_ID:
- Запустите бота (см. ниже) и в ЛС боту отправьте `/id` — бот ответит числом. Это и есть ваш chat_id.

### 3) Запуск

```bash
python bot.py
```

Бот использует long polling. Остановить: Ctrl+C.

### 4) Как это работает

- Вариант А (по умолчанию, `OWNER_ID`): Пользователь пишет боту — бот копирует сообщение вам (владельцу). Ответьте реплаем — бот отправит ответ пользователю.
- Вариант Б (форум, `SUPPORT_CHAT_ID`): Для каждого пользователя создаётся отдельная тема (topic) в супергруппе. Сообщения клиента публикуются в его тему; отвечайте реплаем в нужной теме — бот доставит ответ пользователю.

Персистентность:
- Маппинг пользователь → topic сохраняется в SQLite (`DB_PATH`), переживает рестарт/деплой.

Поддерживаются текст и медиа (копированием сообщения), форматирование сохранится.

### 5) Команды

- `/start` — приветствие для пользователя; подсказка для владельца.
- `/id` — показать текущий chat_id (используйте, чтобы узнать OWNER_ID).
- `/stats` — статистика оценок поддержки (доступна владельцу и администраторам группы поддержки).
- `/diag` — диагностическая информация о боте и настройках.
- `/linkmail <email>` — привязать email пользователя к его Telegram ID (только для админов, работает в теме форума).

### Оценки поддержки

При закрытии темы пользователь автоматически получает сообщение с просьбой оценить работу поддержки (кнопки 1-5). 
Оценки сохраняются в базу данных и доступны через команду `/stats`.

**Уведомления админам**: При каждой оценке администраторы получают уведомление в специальную тему форума (по умолчанию General тема с ID=1). 
Можно настроить другую тему через переменную окружения `RATINGS_NOTIFICATIONS_THREAD_ID`.

### Интеграция с бэкенд API

Команда `/linkmail` позволяет администраторам привязывать email пользователей к их Telegram ID через бэкенд API.

**Как использовать:**
1. Пользователь пишет в тему форума с указанием своего email
2. Администратор входит в тему и выполняет: `/linkmail user@example.com`
3. Бот находит пользователя по email через API
4. Привязывает Telegram ID пользователя к его аккаунту
5. Отображает полную информацию о пользователе (все значения в моноширинном формате для копирования)

**Требования:**
- Настроить `BACKEND_API_URL` в `.env` файле (обязательно)
- Настроить `BACKEND_API_KEY` в `.env` файле (если требуется аутентификация)
- Команда работает только в режиме форума
- Требуются права администратора
- Команда должна выполняться внутри темы, где пользователь уже писал

### 6) Деплой на Ubuntu сервер

#### Быстрый деплой (автоматический)

1. Подключитесь к серверу:
```bash
ssh ubuntu@IP_СЕРВЕРА
```

2. Скачайте и запустите скрипт деплоя:
```bash
curl -O https://raw.githubusercontent.com/sudoloveme/tgsuppbothg/main/deploy.sh
chmod +x deploy.sh
sudo ./deploy.sh
```

3. Создайте файл `.env` в `/opt/tg-support-bot/`:
```bash
sudo nano /opt/tg-support-bot/.env
```
Добавьте:
```
TELEGRAM_BOT_TOKEN=ваш_токен
OWNER_ID=ваш_chat_id
# или для форума:
# SUPPORT_CHAT_ID=-1001234567890
```

4. Перезапустите сервис:
```bash
sudo systemctl restart tg-support-bot
```

#### Ручной деплой

```bash
# На сервере
sudo mkdir -p /opt/tg-support-bot
cd /opt/tg-support-bot
sudo git clone https://github.com/sudoloveme/tgsuppbothg.git .

# Создать venv и установить зависимости
sudo python3 -m venv .venv
sudo .venv/bin/pip install -r requirements.txt

# Создать .env файл
sudo nano .env

# Создать systemd service (см. пример в deploy.sh)

# Запустить
sudo systemctl enable tg-support-bot
sudo systemctl start tg-support-bot
```

#### Полезные команды для управления

```bash
# Просмотр логов
sudo journalctl -u tg-support-bot -f

# Статус сервиса
sudo systemctl status tg-support-bot

# Перезапуск после обновления кода
cd /opt/tg-support-bot
sudo git pull
sudo systemctl restart tg-support-bot

# Остановка/запуск
sudo systemctl stop tg-support-bot
sudo systemctl start tg-support-bot
```

### 7) Примечания

- Соответствия сообщений хранятся в памяти и теряются при перезапуске.
- Для продакшна можно добавить БД или Webhook, но для начала достаточно polling.
- Чтобы включить форум в группе: Превратите группу в супергруппу и включите "Темы" в настройках. Затем добавьте бота с правом создавать темы.


